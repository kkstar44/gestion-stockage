<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gestion de Stockage</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="dashboard">
        <nav class="navbar">
            <div class="nav-brand">
                <h2>üè¢ Gestion de Stockage</h2>
            </div>
            <div class="nav-user">
                <span id="userName">Chargement...</span>
                <button onclick="logout()" class="btn btn-secondary btn-sm">D√©connexion</button>
            </div>
        </nav>

        <div class="dashboard-content">
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon">üì¶</div>
                    <div class="stat-info">
                        <h3 id="totalItems">0</h3>
                        <p>Articles en stock</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-info">
                        <h3 id="totalValue">0 ‚Ç¨</h3>
                        <p>Valeur totale</p>
                    </div>
                </div>
                <div class="stat-card" id="clientsCard" style="display: none; cursor: pointer;" onclick="openClientsListModal()">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-info">
                        <h3 id="totalClients">0</h3>
                        <p>Clients (cliquez pour g√©rer)</p>
                    </div>
                    <button id="addClientBtn" class="btn btn-sm btn-secondary" style="margin-left: auto;" onclick="event.stopPropagation(); openClientModal();">‚ûï</button>
                </div>
            </div>

            <div class="controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Rechercher...">
                </div>
                <div class="controls-buttons">
                    <button id="archivesBtn" class="btn btn-secondary" onclick="toggleArchives()">
                        üìÅ Archives (0)
                    </button>
                    <button id="addMaterialBtn" class="btn btn-primary" style="display: none;">
                        ‚ûï Ajouter une mati√®re
                    </button>
                </div>
            </div>

            <div class="materials-list" id="materialsList">
                <p class="loading">Chargement des donn√©es...</p>
            </div>
        </div>
    </div>

    <!-- Modal pour ajouter/√©diter -->
    <div id="materialModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">Ajouter une mati√®re premi√®re</h2>
            <form id="materialForm">
                <input type="hidden" id="materialId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="materialName">Nom de la mati√®re *</label>
                        <input type="text" id="materialName" required>
                    </div>
                    <div class="form-group">
                        <label for="materialType">Type *</label>
                        <input type="text" id="materialType" required placeholder="Ex: M√©tal, Bois, Pierre...">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="quantity">Quantit√© *</label>
                        <input type="number" id="quantity" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="unit">Unit√© *</label>
                        <select id="unit" required>
                            <option value="kg">Kilogrammes (kg)</option>
                            <option value="t">Tonnes (t)</option>
                            <option value="l">Litres (l)</option>
                            <option value="m3">M√®tres cubes (m¬≥)</option>
                            <option value="unit√©s">Unit√©s</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="storageLocation">Emplacement de stockage *</label>
                        <input type="text" id="storageLocation" required placeholder="Ex: Entrep√¥t A, Zone 12">
                    </div>
                    <div class="form-group">
                        <label for="receptionDate">Date de r√©ception *</label>
                        <input type="date" id="receptionDate" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="certificateNumber">N¬∞ de certificat</label>
                        <input type="text" id="certificateNumber">
                    </div>
                    <div class="form-group">
                        <label for="estimatedValue">Valeur estim√©e (‚Ç¨)</label>
                        <input type="number" id="estimatedValue" step="0.01">
                    </div>
                </div>

                <div class="form-group" id="clientSelectGroup" style="display: none;">
                    <label for="clientSelect">Client *</label>
                    <select id="clientSelect" required>
                        <option value="">S√©lectionner un client...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="notes">Notes</label>
                    <textarea id="notes" rows="3"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal d√©tails -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDetailsModal()">&times;</span>
            <div id="detailsContent"></div>
        </div>
    </div>

    <!-- Modal cr√©er utilisateur (admin) -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeClientModal()">&times;</span>
            <h2 id="createUserTitle">‚ûï Cr√©er un compte</h2>
            <form id="clientForm">
                <div class="form-group">
                    <label for="clientRole">Type de compte *</label>
                    <select id="clientRole" required onchange="updateCreateUserForm()">
                        <option value="client">Client</option>
                        <option value="admin">Administrateur</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="clientName">Nom complet *</label>
                        <input type="text" id="clientName" required>
                    </div>
                    <div class="form-group" id="companyGroup">
                        <label for="clientCompany">Nom de l'entreprise</label>
                        <input type="text" id="clientCompany">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="clientEmail">Email *</label>
                        <input type="email" id="clientEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="clientPassword">Mot de passe *</label>
                        <input type="password" id="clientPassword" required minlength="6">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeClientModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">Cr√©er le compte</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal mouvement (entr√©e/sortie) -->
    <div id="movementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeMovementModal()">&times;</span>
            <h2 id="movementModalTitle">Enregistrer un mouvement</h2>
            <form id="movementForm">
                <input type="hidden" id="movementMaterialId">
                <input type="hidden" id="movementType">
                
                <div class="form-group">
                    <label>Mati√®re concern√©e</label>
                    <p id="movementMaterialName" style="font-weight: bold; color: var(--primary);"></p>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="movementQuantity">Quantit√© *</label>
                        <input type="number" id="movementQuantity" step="0.01" required min="0.01">
                    </div>
                    <div class="form-group">
                        <label>Unit√©</label>
                        <p id="movementUnit" style="padding: 0.75rem 0;"></p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="movementNotes">Notes / Motif</label>
                    <textarea id="movementNotes" rows="2" placeholder="Ex: Vente client, Transfert..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeMovementModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary" id="movementSubmitBtn">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal historique mouvements -->
    <div id="historyModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeHistoryModal()">&times;</span>
            <h2>üìú Historique des mouvements</h2>
            <div id="historyContent"></div>
        </div>
    </div>

    <!-- Modal liste des clients (admin) -->
    <div id="clientsListModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeClientsListModal()">&times;</span>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2>üë• Gestion des clients</h2>
                <button class="btn btn-primary btn-sm" onclick="closeClientsListModal(); openClientModal();">‚ûï Nouveau client</button>
            </div>
            <div id="clientsListContent"></div>
        </div>
    </div>

    <!-- Modal √©diter client (admin) -->
    <div id="editClientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditClientModal()">&times;</span>
            <h2>‚úèÔ∏è Modifier le client</h2>
            <form id="editClientForm">
                <input type="hidden" id="editClientId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editClientName">Nom complet *</label>
                        <input type="text" id="editClientName" required>
                    </div>
                    <div class="form-group">
                        <label for="editClientCompany">Nom de l'entreprise</label>
                        <input type="text" id="editClientCompany">
                    </div>
                </div>
                <div class="form-group">
                    <label for="editClientEmail">Email</label>
                    <input type="email" id="editClientEmail" disabled style="background: var(--bg);">
                    <small style="color: var(--text-light);">L'email ne peut pas √™tre modifi√© ici</small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditClientModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="js/supabase.js"></script>
    <script type="module" src="js/dashboard.js"></script>
</body>
</html>
